{% extends 'googledorks/base.html' %}
{% load static %}

{% block title %}AI Chat Assistant - Google Dorks Toolkit{% endblock %}

{% block extra_head %}
<style>
    .chat-container {
        height: 70vh;
        max-height: 600px;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 20px;
        border-bottom: 1px solid #dee2e6;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f8f9fa;
    }

    .message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
    }

    .message.user {
        justify-content: flex-end;
    }

    .message.bot {
        justify-content: flex-start;
    }

    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
    }

    .message.user .message-content {
        background: #007bff;
        color: white;
        margin-left: 10px;
    }

    .message.bot .message-content {
        background: white;
        color: #333;
        border: 1px solid #e9ecef;
        margin-right: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .message-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 14px;
    }

    .user-avatar {
        background: #28a745;
    }

    .bot-avatar {
        background: #6f42c1;
    }

    .message-time {
        font-size: 11px;
        color: #6c757d;
        margin-top: 4px;
        text-align: right;
    }

    .message.bot .message-time {
        text-align: left;
    }

    .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #dee2e6;
    }

    .chat-input {
        display: flex;
        gap: 10px;
    }

    .chat-input input {
        flex: 1;
        border: 1px solid #ced4da;
        border-radius: 25px;
        padding: 12px 20px;
        outline: none;
        font-size: 14px;
    }

    .chat-input input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, .25);
    }

    .send-btn {
        background: #007bff;
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .send-btn:hover {
        background: #0056b3;
        transform: scale(1.05);
    }

    .send-btn:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }

    .typing-indicator {
        display: none;
        align-items: center;
        margin-bottom: 20px;
    }

    .typing-dots {
        display: flex;
        gap: 4px;
        margin-left: 46px;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #6c757d;
        animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {

        0%,
        60%,
        100% {
            transform: translateY(0);
            opacity: 0.5;
        }

        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }

    .welcome-message {
        text-align: center;
        color: #6c757d;
        padding: 40px 20px;
    }

    .welcome-message i {
        font-size: 48px;
        margin-bottom: 20px;
        color: #007bff;
    }

    .sidebar {
        width: 300px;
        background: white;
        border-right: 1px solid #dee2e6;
        height: 70vh;
        overflow-y: auto;
    }

    .session-item {
        padding: 12px 16px;
        border-bottom: 1px solid #f8f9fa;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .session-item:hover {
        background: #f8f9fa;
    }

    .session-item.active {
        background: #e3f2fd;
        border-left: 3px solid #007bff;
    }

    .session-title {
        font-weight: 500;
        margin-bottom: 4px;
    }

    .session-preview {
        font-size: 12px;
        color: #6c757d;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .new-chat-btn {
        margin: 16px;
        width: calc(100% - 32px);
    }

    .not-configured-alert {
        background: #f8d7da;
        color: #721c24;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .feedback-buttons {
        margin-top: 8px;
        display: flex;
        gap: 8px;
    }

    .feedback-btn {
        background: none;
        border: none;
        color: #6c757d;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .feedback-btn:hover {
        background: #f8f9fa;
        color: #007bff;
    }

    .feedback-btn.active {
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-robot"></i> AI Chat Assistant</h2>
                <div>
                    {% if user.is_authenticated %}
                    <a href="{% url 'chatbot:user_sessions' %}" class="btn btn-outline-primary me-2">
                        <i class="fas fa-history"></i> Chat History
                    </a>
                    {% endif %}
                    {% if user.is_staff %}
                    <a href="{% url 'chatbot:stats' %}" class="btn btn-outline-info">
                        <i class="fas fa-chart-bar"></i> Stats
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if not is_configured %}
    <div class="row">
        <div class="col-12">
            <div class="not-configured-alert">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Chatbot Not Configured:</strong> The Google Gemini API key is not set.
                Please contact an administrator to configure the GEMINI_API_KEY environment variable.
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Sidebar for chat sessions -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-comments"></i> Chat Sessions</h6>
                </div>
                <div class="card-body p-0">
                    <button class="btn btn-primary new-chat-btn" onclick="startNewChat()">
                        <i class="fas fa-plus"></i> New Chat
                    </button>
                    <div id="sessions-list">
                        {% for session in recent_sessions %}
                        <div class="session-item" onclick="loadSession('{{ session.id }}')">
                            <div class="session-title">{{ session.title|truncatechars:30 }}</div>
                            <div class="session-preview">
                                {{ session.get_last_message.content|default:"No messages"|truncatechars:40 }}
                            </div>
                        </div>
                        {% empty %}
                        <div class="text-center p-3 text-muted">
                            <i class="fas fa-comments"></i><br>
                            No chat sessions yet
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Main chat area -->
        <div class="col-md-9">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0" id="chat-title">AI Assistant</h5>
                            <small class="opacity-75">Ask me anything about Google dorking and security
                                research!</small>
                        </div>
                        <div class="text-end">
                            <small id="session-info" class="opacity-75"></small>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="chat-messages">
                    <div class="welcome-message">
                        <i class="fas fa-robot"></i>
                        <h4>Welcome to the AI Assistant!</h4>
                        <p>I'm here to help you with Google dorking techniques, security research, and using this
                            toolkit effectively.</p>
                        <p class="text-muted">Ask me questions like:</p>
                        <div class="text-start">
                            <ul class="list-unstyled">
                                <li><i class="fas fa-chevron-right text-primary"></i> "How do I find login pages using
                                    Google dorks?"</li>
                                <li><i class="fas fa-chevron-right text-primary"></i> "What are the best dorks for
                                    finding SQL injection vulnerabilities?"</li>
                                <li><i class="fas fa-chevron-right text-primary"></i> "Show me dorks for directory
                                    listing discovery"</li>
                                <li><i class="fas fa-chevron-right text-primary"></i> "What are the ethical guidelines
                                    for using these tools?"</li>
                            </ul>
                        </div>
                    </div>

                    <div class="typing-indicator" id="typing-indicator">
                        <div class="message-avatar bot-avatar">AI</div>
                        <div class="typing-dots">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="Ask me anything about Google dorking..."
                            maxlength="1000" {% if not is_configured %}disabled{% endif %} />
                        <button class="send-btn" id="send-btn" onclick="sendMessage()" {% if not is_configured
                            %}disabled{% endif %}>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentSessionId = null;
    let isWaitingForResponse = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        const messageInput = document.getElementById('message-input');

        // Enter key to send message
        messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Auto-resize input
        messageInput.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    });

    async function startNewChat() {
        try {
            const response = await fetch('{% url "chatbot:start_session" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    title: 'New Chat'
                })
            });

            const data = await response.json();

            if (data.success) {
                currentSessionId = data.session_id;
                clearChat();
                document.getElementById('chat-title').textContent = data.title;
                document.getElementById('message-input').focus();
            } else {
                alert('Error starting new chat: ' + data.error);
            }
        } catch (error) {
            console.error('Error starting new chat:', error);
            alert('Error starting new chat');
        }
    }

    async function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();

        if (!message || isWaitingForResponse) return;

        if (!currentSessionId) {
            await startNewChat();
        }

        // Clear input and show user message
        messageInput.value = '';
        addMessage('user', message);

        // Show typing indicator
        showTypingIndicator();
        isWaitingForResponse = true;
        document.getElementById('send-btn').disabled = true;

        try {
            const response = await fetch('{% url "chatbot:send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    message: message
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update session title if it changed
                if (data.session_title) {
                    document.getElementById('chat-title').textContent = data.session_title;
                }

                // Add bot response
                addMessage('bot', data.bot_response.content, data.bot_response.id);
            } else {
                addMessage('bot', 'Sorry, I encountered an error: ' + data.error);
            }
        } catch (error) {
            console.error('Error sending message:', error);
            addMessage('bot', 'Sorry, I couldn\'t process your message. Please try again.');
        } finally {
            hideTypingIndicator();
            isWaitingForResponse = false;
            document.getElementById('send-btn').disabled = false;
            messageInput.focus();
        }
    }

    function addMessage(type, content, messageId = null) {
        const chatMessages = document.getElementById('chat-messages');
        const welcomeMessage = chatMessages.querySelector('.welcome-message');

        // Remove welcome message if it exists
        if (welcomeMessage) {
            welcomeMessage.style.display = 'none';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;

        const avatarDiv = document.createElement('div');
        avatarDiv.className = `message-avatar ${type}-avatar`;
        avatarDiv.textContent = type === 'user' ? 'YOU' : 'AI';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        // Format content (simple markdown-like formatting)
        const formattedContent = formatMessage(content);
        contentDiv.innerHTML = formattedContent;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        if (type === 'user') {
            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(avatarDiv);
            contentDiv.appendChild(timeDiv);
        } else {
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            contentDiv.appendChild(timeDiv);

            // Add feedback buttons for bot messages
            if (messageId) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-buttons';
                feedbackDiv.innerHTML = `
                <button class="feedback-btn" onclick="submitFeedback('${messageId}', 'thumbs_up')" title="Helpful">
                    <i class="fas fa-thumbs-up"></i>
                </button>
                <button class="feedback-btn" onclick="submitFeedback('${messageId}', 'thumbs_down')" title="Not helpful">
                    <i class="fas fa-thumbs-down"></i>
                </button>
            `;
                contentDiv.appendChild(feedbackDiv);
            }
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatMessage(content) {
        // Simple formatting for better readability
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code>$1</code>')
            .replace(/\n/g, '<br>');
    }

    function showTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'flex';
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
        document.getElementById('typing-indicator').style.display = 'none';
    }

    function clearChat() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = `
        <div class="welcome-message">
            <i class="fas fa-robot"></i>
            <h4>New Chat Started!</h4>
            <p>How can I help you with Google dorking and security research today?</p>
        </div>
        <div class="typing-indicator" id="typing-indicator">
            <div class="message-avatar bot-avatar">AI</div>
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    }

    async function submitFeedback(messageId, feedbackType) {
        try {
            const response = await fetch('{% url "chatbot:submit_feedback" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    message_id: messageId,
                    feedback_type: feedbackType
                })
            });

            const data = await response.json();

            if (data.success) {
                // Update button appearance
                event.target.classList.add('active');
                event.target.style.color = '#007bff';
            }
        } catch (error) {
            console.error('Error submitting feedback:', error);
        }
    }

    async function loadSession(sessionId) {
        try {
            const response = await fetch(`/chat/api/session/${sessionId}/messages/`);
            const data = await response.json();

            if (data.success) {
                currentSessionId = sessionId;
                clearChat();

                // Update title
                document.getElementById('chat-title').textContent = data.session.title;

                // Load messages
                data.messages.forEach(message => {
                    addMessage(message.type, message.content, message.id);
                });

                // Update active session in sidebar
                document.querySelectorAll('.session-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.target.closest('.session-item').classList.add('active');
            }
        } catch (error) {
            console.error('Error loading session:', error);
        }
    }

    // Utility function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}