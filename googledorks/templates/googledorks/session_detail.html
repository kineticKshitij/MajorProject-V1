{% extends 'googledorks/base.html' %}

{% block title %}{{ session.name }} - Google Dorks Toolkit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4><i class="bi bi-collection"></i> {{ session.name }}</h4>
                    <span class="badge {% if session.is_completed %}bg-success{% else %}bg-warning{% endif %}">
                        {% if session.is_completed %}Completed{% else %}Active{% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body">
                {% if session.description %}
                <p class="text-muted">{{ session.description }}</p>
                {% endif %}

                <div class="row mb-4">
                    <div class="col-md-4">
                        <h6>Total Dorks</h6>
                        <h3 class="text-primary">{{ session.dorks.count }}</h3>
                    </div>
                    <div class="col-md-4">
                        <h6>Total Results</h6>
                        <h3 class="text-success">{{ session.total_results }}</h3>
                    </div>
                    <div class="col-md-4">
                        <h6>Created</h6>
                        <p class="text-muted">{{ session.created_at|date:"M j, Y" }}</p>
                    </div>
                </div>

                <h5>Dorks in this Session</h5>
                <div class="list-group">
                    {% for dork in session.dorks.all %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                <a href="{% url 'googledorks:dork_detail' dork.pk %}">{{ dork.title }}</a>
                            </h6>
                            <p class="mb-1 text-muted small">{{ dork.description|truncatechars:100 }}</p>
                            <small>
                                <span class="badge difficulty-{{ dork.difficulty }}">{{ dork.get_difficulty_display
                                    }}</span>
                                <span class="risk-{{ dork.risk_level }} ms-2">{{ dork.get_risk_level_display }}</span>
                            </small>
                        </div>
                        <div>
                            <button onclick="executeDork({{ dork.pk }})" class="btn btn-success btn-sm">
                                <i class="bi bi-play"></i> Execute
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4">
                        <p class="text-muted">No dorks in this session.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="bi bi-gear"></i> Session Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if not session.is_completed %}
                    <button class="btn btn-success" onclick="executeAllDorks()">
                        <i class="bi bi-play-fill"></i> Execute All Dorks
                    </button>
                    <button class="btn btn-warning" onclick="markCompleted()">
                        <i class="bi bi-check-circle"></i> Mark Completed
                    </button>
                    {% endif %}

                    <a href="{% url 'googledorks:search_results' %}" class="btn btn-outline-primary">
                        <i class="bi bi-collection"></i> View All Results
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="bi bi-info-circle"></i> Session Info</h6>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-5">Created by:</dt>
                    <dd class="col-sm-7">{{ session.created_by.username }}</dd>

                    <dt class="col-sm-5">Created:</dt>
                    <dd class="col-sm-7">{{ session.created_at|date:"M j, Y g:i A" }}</dd>

                    {% if session.completed_at %}
                    <dt class="col-sm-5">Completed:</dt>
                    <dd class="col-sm-7">{{ session.completed_at|date:"M j, Y g:i A" }}</dd>
                    {% endif %}

                    <dt class="col-sm-5">Total Dorks:</dt>
                    <dd class="col-sm-7">{{ session.dorks.count }}</dd>

                    <dt class="col-sm-5">Total Results:</dt>
                    <dd class="col-sm-7">{{ session.total_results }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script>
    function executeAllDorks() {
        const dorks = {{ session.dorks.all| length
    }};
    if (confirm(`Execute all ${dorks} dorks in this session?`)) {
        // Execute each dork sequentially
        const dorkIds = [{% for dork in session.dorks.all %} { { dork.pk } } {% if not forloop.last %}, {% endif %} {% endfor %}];
    executeNextDork(dorkIds, 0);
    }
}

    function executeNextDork(dorkIds, index) {
        if (index >= dorkIds.length) {
            alert('All dorks executed!');
            location.reload();
            return;
        }

        const dorkId = dorkIds[index];
        fetch(`/dorks/${dorkId}/execute/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log(`Dork ${dorkId}: ${data.message}`);
                // Wait a bit to avoid overwhelming the server
                setTimeout(() => {
                    executeNextDork(dorkIds, index + 1);
                }, 1000);
            })
            .catch(error => {
                console.error(`Error executing dork ${dorkId}:`, error);
                executeNextDork(dorkIds, index + 1); // Continue with next dork
            });
    }

    function markCompleted() {
        // This would need a view to handle marking sessions as completed
        alert('Session completion feature coming soon!');
    }
</script>
{% endblock %}